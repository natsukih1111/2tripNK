<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¤è¼ï¼†å’ŒéŸ³ï½œæ—…è¡Œã®ã—ãŠã‚Š</title>

  <!-- Supabaseï¼ˆå¤«å©¦å…±æœ‰åŒæœŸï¼‰ -->
 <script src="./supabase.js"></script>

  <!-- Google Mapsï¼ˆã‚­ãƒ¼å¿…è¦ï¼‰ -->
  <script>
    // â˜…ã“ã“ã«Google Mapsã®APIã‚­ãƒ¼ã‚’å…¥ã‚Œã‚‹ï¼ˆå¿…é ˆï¼‰
    const GMAPS_API_KEY = "AIzaSyC0PgEopaVfIHTSH8FLx0hHOPVt-EoeaPk";
  </script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4f46e5">

  <!-- iPhoneç”¨ï¼ˆSafariã§ãƒ›ãƒ¼ãƒ è¿½åŠ ã—ãŸæ™‚ã®è¦‹ãˆæ–¹ï¼‰ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="æ—…è¡Œã—ãŠã‚Š">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --accent:#4f46e5;
      --accent2:#06b6d4;
      --danger:#ef4444;
      --shadow: 0 10px 24px rgba(15,23,42,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(79,70,229,.12), transparent 55%),
        radial-gradient(700px 500px at 85% 25%, rgba(6,182,212,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }

    header{
      position:sticky; top:0; z-index:50;
      background: rgba(246,247,251,.90);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{font-size:16px;margin:0}
    .title p{margin:0;font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius:999px;
      background:#fff; border:1px solid var(--border);
      font-size:12px; color:var(--muted);
      box-shadow: var(--shadow);
      user-select:none;
      white-space:nowrap;
    }

    .tabs{
      display:flex; gap:8px; padding:12px 0 2px;
      overflow:auto; -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{display:none}
    .tab{
      flex:0 0 auto;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:.15s transform, .15s background, .15s color, .15s border;
      box-shadow: 0 6px 16px rgba(15,23,42,.06);
    }
    .tab:active{transform:scale(.98)}
    .tab.active{
      background: linear-gradient(135deg, rgba(79,70,229,.12), rgba(6,182,212,.10));
      color:var(--text);
      border-color: rgba(79,70,229,.35);
    }

    main{padding:18px 0 24px}

    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){
      .grid.two{grid-template-columns: 1.2fr .8fr}
      .grid.twoeq{grid-template-columns: 1fr 1fr}
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      position:relative;
      z-index:2;
    }
    .card h2{margin:0 0 8px;font-size:14px}

    /* ãƒˆãƒƒãƒ—ä¸‹ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¬ãƒ©ã‚¹ã£ã½ãï¼ˆèƒŒæ™¯ãŒé€ã‘ã‚‹ï¼‰ */
    #view-top .card.glass{
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(10px);
    }

    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input, textarea, select, button{font:inherit}
    input, textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .btn{
      border:none;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      background: linear-gradient(135deg, rgba(79,70,229,.92), rgba(6,182,212,.72));
      color:#fff;
      font-weight:800;
      box-shadow: 0 10px 20px rgba(79,70,229,.18);
      position:relative;
      z-index:5;
    }
    .btn.secondary{
      background:#fff;
      color:var(--text);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      font-weight:700;
    }
    .btn.danger{
      background: rgba(239,68,68,.10);
      color: #b91c1c;
      border:1px solid rgba(239,68,68,.25);
      font-weight:800;
      box-shadow:none;
    }

    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      position:relative;
      z-index:3;
    }
    .item .meta{display:flex; flex-direction:column; gap:4px}
    .item .meta .t{font-weight:800;font-size:13px}
    .item .meta .s{font-size:12px;color:var(--muted);white-space:pre-wrap}
    .tag{
      font-size:11px; color: var(--muted);
      padding:4px 8px; border-radius:999px;
      border:1px solid var(--border);
      background: #f8fafc;
      width:max-content;
    }

    .view{display:none}
    .view.active{display:block}

    /* SGè©³ç´°å†…ã®ã‚¿ãƒ–ä¸­èº«ï¼šactiveã ã‘è¡¨ç¤º */
    #view-sg .section{ display:none; }
    #view-sg .section.active{ display:block; }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:20px;
      background:#111827;
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      display:none;
      z-index:80;
    }
    .toast.show{display:block}

    /* ============ ãƒˆãƒƒãƒ—ï¼šå†™çœŸãŒæµã‚Œã‚‹èƒŒæ™¯ï¼ˆã‚¯ãƒªãƒƒã‚¯ä¸èƒ½å¯¾ç­–ï¼‰ ============ */
    .hero{
      position:relative;
      isolation:isolate;
      border-radius: 22px;
      overflow:hidden;
      min-height: 260px;
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      background: linear-gradient(135deg, rgba(79,70,229,.10), rgba(6,182,212,.10));
      margin-bottom: 14px;
    }
    .hero .bg{
      position:absolute; inset:0;
      z-index:0;
      pointer-events:none;
    }
    .hero .overlay{
      position:absolute; inset:0;
      z-index:1;
      pointer-events:none;
      background: linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.92));
    }
    .hero .content{
      position:relative;
      z-index:2;
      pointer-events:auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .marquee, .imgChip, .imgChip img{ pointer-events:none; }
    .hidden{ display:none !important; }

    .marquee{
      position:absolute;
      inset:auto 0 0 0;
      height: 120%;
      top:-10%;
      display:flex;
      gap:14px;
      align-items:center;
      transform: rotate(-6deg);
      opacity:.50;
      filter: saturate(1.05);
    }
    .marquee.track1{ animation: scroll1 26s linear infinite; z-index:0; }
    .marquee.track2{ animation: scroll2 34s linear infinite; top:10%; opacity:.35; z-index:0; }
    @keyframes scroll1{
      0%{ transform: translateX(0) rotate(-6deg); }
      100%{ transform: translateX(-50%) rotate(-6deg); }
    }
    @keyframes scroll2{
      0%{ transform: translateX(-10%) rotate(-6deg); }
      100%{ transform: translateX(-60%) rotate(-6deg); }
    }
    .imgChip{
      width: 200px;
      height: 140px;
      border-radius: 18px;
      overflow:hidden;
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 22px rgba(15,23,42,.10);
      flex:0 0 auto;
    }
    .imgChip img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }

    a{color:var(--accent)}

    /* MRT viewer */
    #mrtViewer { touch-action:none; }

    /* Album modal */
    #slideModal.hidden{ display:none !important; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1 id="headerTitle">å¤è¼ï¼†å’ŒéŸ³ï½œæ—…è¡Œã®ã—ãŠã‚Š</h1>
        <p id="headerSub">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</p>
      </div>
      <div class="pill" id="syncState">ä¿å­˜ï¼šãƒ­ãƒ¼ã‚«ãƒ«</div>
      <button class="btn secondary" id="goHomeBtn">ğŸ  ãƒ›ãƒ¼ãƒ </button>
    </div>

    <!-- ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«è©³ç´°ã®ã¨ãã ã‘å‡ºã™ -->
    <div class="tabs" id="tabs" style="display:none">
      <div class="tab active" data-tab="day">æ—¥ä»˜æ¯ã®ãƒ—ãƒ©ãƒ³</div>
      <div class="tab" data-tab="mrt">mrt_map</div>
      <div class="tab" data-tab="map">åœ°å›³ï¼ˆæ——ï¼‰</div>
      <div class="tab" data-tab="shop">è²·ã„ç‰©äºˆå®š</div>
      <div class="tab" data-tab="ticket">ãƒã‚±ãƒƒãƒˆ</div>
      <div class="tab" data-tab="album">ã‚¢ãƒ«ãƒãƒ </div>
      <div class="tab" data-tab="share">å…±æœ‰ï¼ˆå¤«å©¦åŒæœŸï¼‰</div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- =================== TOP VIEW =================== -->
  <section class="view active" id="view-top">
    <div class="hero">
      <div class="bg" id="heroBg"></div>
      <div class="overlay"></div>

      <div class="content">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap">
          <div>
            <div style="font-size:18px;font-weight:950;letter-spacing:.01em">å¤è¼ï¼†å’ŒéŸ³ã®æ—…è¡Œã®ã—ãŠã‚Š</div>
            <div class="muted">å†™çœŸã‚’ç™»éŒ²ã™ã‚‹ã¨ã€èƒŒæ™¯ã«ã‚ªã‚·ãƒ£ãƒ¬ã«æµã‚Œã‚‹</div>
          </div>
          <button class="btn secondary" id="goSingaporeBtn">ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«æ—…è¡Œ 2026/02/07ï½02/14</button>
        </div>

        <!-- å†™çœŸç™»éŒ²ï¼šæŠ˜ã‚ŠãŸãŸã¿ -->
        <div class="card" style="margin-top:6px" id="photoPanel">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h2 style="margin:0">ãƒˆãƒƒãƒ—å†™çœŸï¼ˆè¤‡æ•°OKï¼‰</h2>
            <button class="btn secondary" id="togglePhotoPanelBtn">é–‰ã˜ã‚‹</button>
          </div>

          <div id="photoPanelBody">
            <div class="muted">ã‚¹ãƒãƒ›ãªã‚‰å†™çœŸã‚’é¸ã¶ã ã‘ã€‚ç™»éŒ²ã—ãŸå†™çœŸãŒèƒŒæ™¯ã§æµã‚Œã‚‹ã€‚</div>
            <div style="height:10px"></div>
            <input type="file" id="photoInput" accept="image/*" multiple />
            <div class="row" style="justify-content:space-between;margin-top:10px">
              <button class="btn" id="addPhotosBtn">å†™çœŸã‚’ç™»éŒ²</button>
              <button class="btn danger" id="clearPhotosBtn">å†™çœŸã‚’å…¨å‰Šé™¤</button>
            </div>
            <div class="list" id="photoList"></div>
          </div>
        </div>

      </div>
    </div>

    <div class="grid twoeq">
      <div class="card glass">
        <h2>æ—…è¡Œä¸€è¦§</h2>
        <div class="muted">æ—…è¡Œã‚’è¿½åŠ ã™ã‚‹æ©Ÿèƒ½ã¯æ¬¡ã§è¿½åŠ ã§ãã‚‹ï¼ˆä»Šã¯ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«å›ºå®šï¼‰</div>
        <div class="list">
          <div class="item">
            <div class="meta">
              <div class="t">ğŸ‡¸ğŸ‡¬ ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«æ—…è¡Œ</div>
              <div class="s">2026/02/07ã€œ02/14</div>
            </div>
            <div class="row" style="gap:8px">
              <button class="btn" id="goSingaporeBtn2">é–‹ã</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card glass">
        <h2>ä½¿ã„æ–¹</h2>
        <div class="muted">
          ãƒ»æ—¥ä»˜æ¯ã«äºˆå®šã‚’å…¥ã‚Œã‚‹<br/>
          ãƒ»mrt_mapã‚’æ‹¡å¤§ã—ã¦è¦‹ã‚‹<br/>
          ãƒ»åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ——ã‚’ç«‹ã¦ã‚‹ï¼ä½æ‰€ã‹ã‚‰æ——ã‚‚OK<br/>
          ãƒ»ã‚¢ãƒ«ãƒãƒ ã«å†™çœŸã‚’å…¥ã‚Œã¦ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼<br/>
          ãƒ»å…±æœ‰ã‚’ONã«ã™ã‚‹ã¨å¤«å©¦ã§åŒæœŸï¼ˆSupabaseï¼‰<br/>
        </div>
      </div>
    </div>
  </section>

  <!-- =================== SINGAPORE VIEW =================== -->
  <section class="view" id="view-sg">

    <!-- æ—¥ä»˜æ¯ã®ãƒ—ãƒ©ãƒ³ -->
    <section class="section active" id="section-day">
      <div class="grid two">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <h2 style="margin:0">æ—¥ä»˜æ¯ã®ãƒ—ãƒ©ãƒ³</h2>
              <div class="muted">2026/02/07ã€œ02/14</div>
            </div>
            <button class="btn secondary" id="backTopBtn">â† ãƒˆãƒƒãƒ—ã¸</button>
          </div>

          <div style="height:12px"></div>

          <div class="row">
            <div style="flex:1;min-width:220px">
              <label class="muted">æ—¥ä»˜</label>
              <select id="daySelect"></select>
            </div>
            <div style="flex:2;min-width:260px">
              <label class="muted">ãã®æ—¥ã®ãƒ¡ãƒ¢</label>
              <input id="dayMemo" placeholder="ä¾‹ï¼šæœã¯ãƒ›ãƒ†ãƒ«ã§ã‚†ã£ãã‚Š" />
            </div>
          </div>

          <div style="height:12px"></div>
          <h2>äºˆå®šã‚’è¿½åŠ </h2>

          <div class="row">
            <div style="flex:1;min-width:240px">
              <label class="muted">æ™‚é–“ï¼ˆæ™‚ / åˆ†ï¼‰</label>
              <div class="row" style="flex-wrap:nowrap;gap:8px">
                <select id="planHour" style="width:120px"></select>
                <select id="planMin" style="width:120px"></select>
                <select id="planAllDay" style="width:120px">
                  <option value="time">æ™‚åˆ»</option>
                  <option value="all">çµ‚æ—¥</option>
                </select>
              </div>
            </div>

            <div style="flex:2;min-width:220px">
              <label class="muted">ã‚¿ã‚¤ãƒˆãƒ«</label>
              <input id="planTitle" placeholder="ä¾‹ï¼šãƒãƒ¼ãƒ©ã‚¤ã‚ªãƒ³å…¬åœ’" />
            </div>

            <div style="flex:1;min-width:200px">
              <label class="muted">ã‚¢ã‚¤ã‚³ãƒ³</label>
              <select id="planIcon">
                <option value="none">ãªã—</option>
                <option value="meal">ğŸ½ é£Ÿäº‹</option>
                <option value="leisure">ğŸ¡ ãƒ¬ã‚¸ãƒ£ãƒ¼</option>
                <option value="snack">ğŸ° ãŠã‚„ã¤</option>
                <option value="shopping">ğŸ› è²·ã„ç‰©</option>
                <option value="hotel">ğŸ¨ ãƒ›ãƒ†ãƒ«</option>
                <option value="move">ğŸš• ç§»å‹•</option>
                <option value="spot">ğŸ“ è¦³å…‰</option>
                <option value="note">ğŸ“ ãƒ¡ãƒ¢</option>
              </select>
            </div>
          </div>

          <div style="height:8px"></div>
          <div class="row">
            <div style="flex:1;min-width:180px">
              <label class="muted">ç§»å‹•æ‰‹æ®µ</label>
              <select id="planMove">
                <option value="none">æœªè¨­å®š</option>
                <option value="walk">å¾’æ­©</option>
                <option value="mrt">MRT</option>
                <option value="bus">ãƒã‚¹</option>
                <option value="grab">Grab/ã‚¿ã‚¯ã‚·ãƒ¼</option>
                <option value="other">ãã®ä»–</option>
              </select>
            </div>
            <div style="flex:2;min-width:240px">
              <label class="muted">ç§»å‹•ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
              <input id="planMoveMemo" placeholder="ä¾‹ï¼šDTLã§Bugisâ†’Bayfront" />
            </div>
          </div>

          <div style="height:8px"></div>
          <label class="muted">è©³ç´°ï¼ˆå ´æ‰€/URL/æ³¨æ„ç‚¹ãªã©ï¼‰</label>
          <textarea id="planDesc" placeholder="ä¾‹ï¼šMRTã§ã€‡ã€‡é§…â†’å¾’æ­©5åˆ†ï¼ãƒã‚±ãƒƒãƒˆURLâ€¦"></textarea>

          <div class="row" style="justify-content:space-between;margin-top:10px">
            <button class="btn" id="addPlanBtn">è¿½åŠ </button>
            <button class="btn secondary" id="clearPlanInputs">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
          </div>
        </div>

        <div class="card">
          <h2>ãã®æ—¥ã®äºˆå®š</h2>
          <div class="muted">æ™‚é–“é †ã«ä¸¦ã¶ï¼ˆçµ‚æ—¥ã¯ä¸Šï¼‰</div>
          <div class="list" id="planList"></div>
        </div>
      </div>
    </section>

    <!-- mrt_map -->
    <section class="section" id="section-mrt">
      <div class="grid twoeq">
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <h2 style="margin:0">MRT è·¯ç·šå›³</h2>
              <div class="muted">ãƒ”ãƒ³ãƒ/ãƒ›ã‚¤ãƒ¼ãƒ«/ãƒœã‚¿ãƒ³ã§æ‹¡å¤§ç¸®å°ï¼ˆç”»åƒï¼šmrt_map.jpgï¼‰</div>
            </div>
            <div class="row" style="gap:8px">
              <button class="btn secondary" id="mrtZoomOut">âˆ’</button>
              <button class="btn secondary" id="mrtZoomReset">å…¨ä½“</button>
              <button class="btn secondary" id="mrtZoomIn">ï¼‹</button>
            </div>
          </div>

          <div style="height:10px"></div>

          <div id="mrtViewer"
               style="border:1px solid var(--border);border-radius:16px;overflow:hidden;background:#fff;height:520px;touch-action:none;position:relative">
            <img id="mrtImg" src="mrt_map.jpg" alt="mrt_map"
                 style="transform-origin:0 0;transform:translate(0px,0px) scale(1);user-select:none;-webkit-user-drag:none;position:absolute;left:0;top:0;max-width:none"/>
          </div>
          <div class="muted" style="margin-top:8px">
            â€»è¡¨ç¤ºã•ã‚Œãªã„å ´åˆï¼šindex.html ã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã€Œmrt_map.jpgã€ã‚’ç½®ã„ã¦ã­
          </div>
        </div>

        <div class="card">
          <h2>ãƒ¡ãƒ¢</h2>
          <div class="muted">è·¯ç·šå›³ã‚’è¦‹ãªãŒã‚‰ãƒ¡ãƒ¢ã«ä½¿ã£ã¦OK</div>
          <div style="height:10px"></div>
          <textarea id="mrtFreeMemo" placeholder="ä¾‹ï¼šã“ã®æ—¥ã¯DTLã§Bugisâ†’Bayfrontâ€¦"></textarea>
          <div class="row" style="justify-content:space-between;margin-top:10px">
            <button class="btn" id="saveMrtFreeMemoBtn">ä¿å­˜</button>
            <button class="btn danger" id="clearMrtFreeMemoBtn">æ¶ˆã™</button>
          </div>
        </div>
      </div>
    </section>

    <!-- åœ°å›³ï¼ˆæ——ï¼‰ -->
    <section class="section" id="section-map">
      <div class="grid two">
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <h2 style="margin:0">åœ°å›³ï¼ˆGoogle Mapsï¼‰</h2>
              <div class="muted">åœ°å›³ã‚¿ãƒƒãƒ—ã§æ—— / ä½æ‰€å…¥åŠ›ã§ã‚‚æ——ï¼ˆã‚«ãƒ†ã‚´ãƒªã§è‰²åˆ†ã‘ï¼‰</div>
            </div>

            <div class="row" style="gap:8px">
              <select id="mapLang" style="width:160px">
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="en">English</option>
              </select>
              <button class="btn secondary" id="reloadMapBtn">è¨€èªåæ˜ </button>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <div style="flex:2;min-width:220px">
              <label class="muted">ä½æ‰€/æ–½è¨­åï¼ˆä¾‹ï¼šMarina Bay Sandsï¼‰</label>
              <input id="pinAddress" placeholder="ä¾‹ï¼šGardens by the Bay" />
            </div>
            <div style="flex:1;min-width:220px">
              <label class="muted">æ——ã®åå‰</label>
              <input id="pinName2" placeholder="ä¾‹ï¼šMBSï¼ˆç©ºãªã‚‰ä½æ‰€ãŒåå‰ã«ãªã‚‹ï¼‰" />
            </div>
            <div style="flex:1;min-width:180px">
              <label class="muted">ã‚«ãƒ†ã‚´ãƒª</label>
              <select id="pinCat">
                <option value="spot">ğŸ“ è¦³å…‰</option>
                <option value="meal">ğŸ½ é£Ÿäº‹</option>
                <option value="shopping">ğŸ› è²·ã„ç‰©</option>
                <option value="hotel">ğŸ¨ ãƒ›ãƒ†ãƒ«</option>
                <option value="move">ğŸš• ç§»å‹•</option>
                <option value="note">ğŸ“ ãƒ¡ãƒ¢</option>
              </select>
            </div>
          </div>

          <div class="row" style="justify-content:space-between;margin-top:10px">
            <button class="btn" id="addPinByAddressBtn">ä½æ‰€ã‹ã‚‰æ——ã‚’è¿½åŠ </button>
            <button class="btn secondary" id="hintTapBtn">åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¿½åŠ </button>
          </div>

          <div style="height:10px"></div>

          <div style="border:1px solid var(--border);border-radius:16px;overflow:hidden;background:#fff">
            <div id="gmap" style="width:100%;height:420px;"></div>
          </div>

          <div class="muted" style="margin-top:8px">
            â€»Google MapsãŒè¡¨ç¤ºã•ã‚Œãªã„ â†’ APIã‚­ãƒ¼æœªè¨­å®š/åˆ¶é™ã®å¯èƒ½æ€§ï¼ˆGMAPS_API_KEYï¼‰
          </div>
        </div>

        <div class="card">
          <h2>å ´æ‰€ãƒªã‚¹ãƒˆï¼ˆæ——ï¼‰</h2>
          <div class="muted">ã€Œåœ°å›³ã¸ã€/ã€Œå‰Šé™¤ã€</div>
          <div class="list" id="pinList"></div>
        </div>
      </div>
    </section>

    <!-- è²·ã„ç‰©äºˆå®š -->
    <section class="section" id="section-shop">
      <div class="grid two">
        <div class="card">
          <h2>è²·ã„ç‰©äºˆå®šã‚’è¿½åŠ </h2>
          <div class="row">
            <div style="flex:2;min-width:220px">
              <label class="muted">ã‚¢ã‚¤ãƒ†ãƒ </label>
              <input id="shopItem" placeholder="ä¾‹ï¼šTWGã®ç´…èŒ¶" />
            </div>
            <div style="flex:2;min-width:220px">
              <label class="muted">å ´æ‰€/åº—</label>
              <input id="shopPlace" placeholder="ä¾‹ï¼šION Orchard" />
            </div>
          </div>
          <div style="height:8px"></div>
          <label class="muted">ãƒ¡ãƒ¢</label>
          <input id="shopMemo" placeholder="ä¾‹ï¼šãŠåœŸç”£ç”¨ï¼ä¾¡æ ¼ã®ç›®å®‰â€¦" />
          <div style="height:10px"></div>
          <button class="btn" id="addShopBtn">è¿½åŠ </button>
        </div>

        <div class="card">
          <h2>è²·ã„ç‰©ãƒªã‚¹ãƒˆ</h2>
          <div class="muted">ãƒã‚§ãƒƒã‚¯ã—ã¦æ¶ˆã—è¾¼ã¿ã§ãã‚‹</div>
          <div class="list" id="shopList"></div>
        </div>
      </div>
    </section>

    <!-- ãƒã‚±ãƒƒãƒˆ -->
    <section class="section" id="section-ticket">
      <div class="grid two">
        <div class="card">
          <h2>ãƒã‚±ãƒƒãƒˆ/äºˆç´„ã‚’è¿½åŠ </h2>
          <label class="muted">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input id="tTitle" placeholder="ä¾‹ï¼šèˆªç©ºåˆ¸ï¼ˆå¾€è·¯ï¼‰" />
          <div style="height:8px"></div>
          <label class="muted">å†…å®¹ï¼ˆäºˆç´„ç•ªå·ã€URLã€é›†åˆå ´æ‰€ãªã©ï¼‰</label>
          <textarea id="tBody" placeholder="ä¾‹ï¼šäºˆç´„ç•ªå·ï¼šXXX / URLï¼š... / é›†åˆï¼š..."></textarea>
          <div style="height:10px"></div>
          <button class="btn" id="addTicketBtn">è¿½åŠ </button>
          <div style="height:12px"></div>
          <div class="muted">â€»QRç”»åƒã¯â€œç”»åƒURLâ€è²¼ã‚Šä»˜ã‘é‹ç”¨ãŒæœ€é€Ÿ</div>
        </div>

        <div class="card">
          <h2>ãƒã‚±ãƒƒãƒˆä¸€è¦§</h2>
          <div class="list" id="ticketList"></div>
        </div>
      </div>
    </section>

    <!-- ã‚¢ãƒ«ãƒãƒ  -->
    <section class="section" id="section-album">
      <div class="grid twoeq">
        <div class="card">
          <h2>ã‚¢ãƒ«ãƒãƒ ã«å†™çœŸã‚’è¿½åŠ </h2>
          <div class="muted">è¿½åŠ ã—ãŸå†™çœŸã‚’ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼ã§è¦‹ã‚Œã‚‹</div>
          <div style="height:10px"></div>
          <input type="file" id="albumInput" accept="image/*" multiple />
          <div class="row" style="justify-content:space-between;margin-top:10px">
            <button class="btn" id="addAlbumBtn">ã‚¢ãƒ«ãƒãƒ ã«è¿½åŠ </button>
            <button class="btn danger" id="clearAlbumBtn">å…¨å‰Šé™¤</button>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn secondary" id="playSlideBtn">â–¶ ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼</button>
          </div>
          <div class="muted" style="margin-top:10px">
            â€»å†™çœŸã¯ç«¯æœ«å†…ã«ä¿å­˜ï¼ˆå…±æœ‰ONã§ã‚‚å†™çœŸã¯é‡ããªã‚‹ã®ã§åŸºæœ¬ãƒ­ãƒ¼ã‚«ãƒ«æ¨å¥¨ï¼‰
          </div>
        </div>

        <div class="card">
          <h2>ã‚¢ãƒ«ãƒãƒ </h2>
          <div class="list" id="albumList"></div>
        </div>
      </div>

      <!-- ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼ç”¨ -->
      <div id="slideModal" class="hidden" style="
        position:fixed;inset:0;z-index:100;
        background:rgba(15,23,42,.75);
        display:flex;align-items:center;justify-content:center;
        padding:18px;">
        <div style="max-width:900px;width:100%">
          <div class="row" style="justify-content:space-between;margin-bottom:10px">
            <div class="pill" id="slideInfo">1 / 1</div>
            <button class="btn secondary" id="closeSlideBtn">é–‰ã˜ã‚‹</button>
          </div>
          <div style="background:#000;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.15)">
            <img id="slideImg" style="width:100%;height:70vh;object-fit:contain;display:block" />
          </div>
          <div class="row" style="justify-content:space-between;margin-top:10px">
            <button class="btn secondary" id="prevSlideBtn">â†</button>
            <button class="btn secondary" id="nextSlideBtn">â†’</button>
          </div>
        </div>
      </div>
    </section>

    <!-- å…±æœ‰ï¼ˆå¤«å©¦åŒæœŸï¼‰ -->
    <section class="section" id="section-share">
      <div class="grid two">
        <div class="card">
          <h2>å¤«å©¦å…±æœ‰ï¼ˆåŒæœŸï¼‰</h2>
          <div class="muted">
            åŒã˜ã€Œå…±æœ‰ã‚³ãƒ¼ãƒ‰ã€ã§åŒã˜æ—…ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‰ã‚Œã‚‹ã€‚<br/>
            â€»Supabaseæœªè¨­å®šãªã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¾ã¾å‹•ã
          </div>

          <div style="height:10px"></div>
          <label class="muted">å…±æœ‰ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šnatsuki-kazune-sg2026ï¼‰</label>
          <input id="shareCode" placeholder="ä¾‹ï¼šnatsuki-kazune-sg2026" />

          <div style="height:8px"></div>
          <label class="muted">åˆè¨€è‘‰ï¼ˆãƒ‘ã‚¹ï¼‰</label>
          <input id="sharePass" type="password" placeholder="å¤«å©¦ã ã‘ãŒçŸ¥ã£ã¦ã‚‹ã‚„ã¤" />

          <div class="row" style="justify-content:space-between;margin-top:10px">
            <button class="btn" id="connectShareBtn">å…±æœ‰ã§ä½¿ã†</button>
            <button class="btn secondary" id="disconnectShareBtn">ãƒ­ãƒ¼ã‚«ãƒ«ã«æˆ»ã™</button>
          </div>

          <div style="height:12px"></div>
          <div class="muted">
            ä»•çµ„ã¿ï¼šã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã«æ—…ãƒ‡ãƒ¼ã‚¿(JSON)ã‚’1ã¤ä¿å­˜ã—ã¦ä¸¡ç«¯æœ«ã§åŒæœŸã€‚
          </div>
        </div>

        <div class="card">
          <h2>åŒæœŸãƒ­ã‚°</h2>
          <div class="list" id="shareLog"></div>
        </div>
      </div>
    </section>

  </section>

  <div class="toast" id="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>
</main>

<script>
  // =========================
  // Supabase è¨­å®šï¼ˆä½¿ã†å ´åˆã ã‘å…¥ã‚Œã‚‹ï¼‰
  // =========================
  const SUPABASE_URL = "https://wrdxpnsevzlbbnwqjdwf.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_j0ELdUy642C8My25peJXpg_MOzrTXS0";
  const SHARE_TABLE = "trip_docs";

  // =========================
  // State
  // =========================
  const TOP_KEY = "natsu_kazu_top_v1";
  const TRIP_LOCAL_KEY = "trip_sg_2026_natsuki_kazune_v6_pwa_album";

  const defaultTopState = {
    photos: [],
    ui: { photoPanelOpen: true }
  };

  const defaultTripState = {
    meta: { trip: "Singapore", start:"2026-02-07", end:"2026-02-14" },
    share: { enabled:false, code:"", passHash:"" },
    mrt: { freeMemo:"" },
    pins: [
      { name:"Changi Airport", lat:1.3644, lng:103.9915, cat:"move" },
      { name:"Marina Bay Sands", lat:1.2834, lng:103.8607, cat:"spot" },
      { name:"Gardens by the Bay", lat:1.2816, lng:103.8636, cat:"spot" }
    ],
    shopping: [],
    tickets: [],
    albumPhotos: [],
    days: {}
  };

  const DATES = (function makeDates(start, end){
    const out = [];
    const s = new Date(start), e = new Date(end);
    for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const day=String(d.getDate()).padStart(2,"0");
      out.push(`${y}-${m}-${day}`);
    }
    return out;
  })(defaultTripState.meta.start, defaultTripState.meta.end);

  let topState = loadJson(TOP_KEY, defaultTopState);
  let state = loadJson(TRIP_LOCAL_KEY, defaultTripState);

  // =========================
  // Helpers
  // =========================
  function loadJson(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return structuredClone(fallback);
      const obj = JSON.parse(raw);
      return { ...structuredClone(fallback), ...obj };
    }catch(e){
      console.warn(e);
      return structuredClone(fallback);
    }
  }
  function saveJson(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
  function flash(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1200);
  }
  function setSyncLabel(text){ document.getElementById("syncState").textContent = text; }
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[s]));
  }
  function linkify(str){
    const urlRe = /(https?:\/\/[^\s]+)/g;
    return str.replace(urlRe, (u)=>`<a href="${u}" target="_blank" rel="noopener noreferrer">${u}</a>`);
  }
  function iconLabel(v){
    return ({
      none:"", meal:"ğŸ½", leisure:"ğŸ¡", snack:"ğŸ°", shopping:"ğŸ›",
      hotel:"ğŸ¨", move:"ğŸš•", spot:"ğŸ“", note:"ğŸ“"
    }[v] || "");
  }
  async function fileToDataURL(file){
    return new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  // =========================
  // View Navigation (Top <-> SG)
  // =========================
  const viewTop = document.getElementById("view-top");
  const viewSg = document.getElementById("view-sg");
  const tabs = document.getElementById("tabs");

  function showTop(){
    viewTop.classList.add("active");
    viewSg.classList.remove("active");
    tabs.style.display = "none";
    document.getElementById("headerTitle").textContent = "å¤è¼ï¼†å’ŒéŸ³ï½œæ—…è¡Œã®ã—ãŠã‚Š";
    document.getElementById("headerSub").textContent = "ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸";
  }
  function showSg(){
    viewTop.classList.remove("active");
    viewSg.classList.add("active");
    tabs.style.display = "flex";
    document.getElementById("headerTitle").textContent = "å¤è¼ï¼†å’ŒéŸ³ï½œæ—…è¡Œãƒ—ãƒ©ãƒ³";
    document.getElementById("headerSub").textContent = "ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«æ—…è¡Œï¼ˆ2026/02/07ã€œ02/14ï¼‰";
    activateTab("day");
  }

  document.getElementById("goSingaporeBtn").addEventListener("click", showSg);
  document.getElementById("goSingaporeBtn2").addEventListener("click", showSg);
  document.getElementById("backTopBtn").addEventListener("click", showTop);
  document.getElementById("goHomeBtn").addEventListener("click", showTop);

  // =========================
  // Tabs inside SG
  // =========================
  function activateTab(key){
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.querySelector(`.tab[data-tab="${key}"]`)?.classList.add("active");
    document.querySelectorAll("#view-sg .section").forEach(s=>s.classList.remove("active"));
    document.getElementById(`section-${key}`).classList.add("active");

    if(key==="map") renderMap();
    if(key==="mrt") renderMrtUi();
    if(key==="album") renderAlbum();
  }
  tabs.addEventListener("click", (e)=>{
    const t = e.target.closest(".tab");
    if(!t) return;
    activateTab(t.dataset.tab);
  });

  // =========================
  // Photo panel toggle
  // =========================
  const togglePhotoPanelBtn = document.getElementById("togglePhotoPanelBtn");
  const photoPanelBody = document.getElementById("photoPanelBody");
  function setPhotoPanel(open){
    if(open){
      photoPanelBody.classList.remove("hidden");
      togglePhotoPanelBtn.textContent = "é–‰ã˜ã‚‹";
    }else{
      photoPanelBody.classList.add("hidden");
      togglePhotoPanelBtn.textContent = "é–‹ã";
    }
    topState.ui = topState.ui || {};
    topState.ui.photoPanelOpen = open;
    saveJson(TOP_KEY, topState);
  }
  togglePhotoPanelBtn.addEventListener("click", ()=>{
    const isOpen = !photoPanelBody.classList.contains("hidden");
    setPhotoPanel(!isOpen);
  });

  // =========================
  // Top Photos (æµã‚Œã‚‹èƒŒæ™¯)
  // =========================
  const photoInput = document.getElementById("photoInput");
  const photoList = document.getElementById("photoList");
  const heroBg = document.getElementById("heroBg");

  function renderPhotos(){
    photoList.innerHTML = "";
    if((topState.photos||[]).length===0){
      photoList.innerHTML = `<div class="muted" style="margin-top:10px">ã¾ã å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆç™»éŒ²ã™ã‚‹ã¨èƒŒæ™¯ãŒæµã‚Œã‚‹ï¼‰</div>`;
    } else {
      topState.photos.slice().reverse().forEach((src, idxFromEnd)=>{
        const idx = topState.photos.length - 1 - idxFromEnd;
        const el = document.createElement("div");
        el.className="item";
        el.innerHTML = `
          <div class="meta">
            <div class="t">ğŸ“· å†™çœŸ ${idx+1}</div>
            <div class="s">ï¼ˆã‚¿ãƒƒãƒ—å‰Šé™¤ï¼‰</div>
          </div>
          <div style="width:90px;height:60px;border-radius:12px;overflow:hidden;border:1px solid var(--border)">
            <img src="${src}" style="width:100%;height:100%;object-fit:cover;display:block" />
          </div>
        `;
        el.style.cursor="pointer";
        el.addEventListener("click", ()=>{
          if(!confirm("ã“ã®å†™çœŸã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ")) return;
          topState.photos.splice(idx,1);
          saveJson(TOP_KEY, topState);
          renderPhotos();
          renderHeroBg();
          flash("å‰Šé™¤ã—ãŸ");
        });
        photoList.appendChild(el);
      });
    }
  }

  function buildMarqueeTrack(photos, cls){
    const track = document.createElement("div");
    track.className = `marquee ${cls}`;
    const doubled = photos.concat(photos);
    doubled.forEach(src=>{
      const chip = document.createElement("div");
      chip.className="imgChip";
      chip.innerHTML = `<img src="${src}" alt="">`;
      track.appendChild(chip);
    });
    return track;
  }

  function renderHeroBg(){
    heroBg.innerHTML = "";
    const photos = (topState.photos && topState.photos.length) ? topState.photos : [
      "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='800' height='560'>
          <defs>
            <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
              <stop offset='0' stop-color='#4f46e5' stop-opacity='.22'/>
              <stop offset='1' stop-color='#06b6d4' stop-opacity='.18'/>
            </linearGradient>
          </defs>
          <rect width='100%' height='100%' fill='url(#g)'/>
          <text x='40' y='120' fill='rgba(15,23,42,.70)' font-size='44' font-family='system-ui'>æ—…ã®å†™çœŸã‚’ç™»éŒ²ã—ã‚ˆã†</text>
        </svg>
      `)
    ];
    heroBg.appendChild(buildMarqueeTrack(photos, "track1"));
    heroBg.appendChild(buildMarqueeTrack(photos, "track2"));
  }

  document.getElementById("addPhotosBtn").addEventListener("click", async ()=>{
    const files = Array.from(photoInput.files || []);
    if(files.length===0) return flash("å†™çœŸã‚’é¸ã‚“ã§ã­");

    topState.photos = topState.photos || [];
    const allow = 12 - topState.photos.length;
    const use = files.slice(0, Math.max(0, allow));
    if(use.length===0) return flash("å†™çœŸã¯æœ€å¤§12æšã¾ã§");

    for(const f of use){
      const dataUrl = await fileToDataURL(f);
      topState.photos.push(dataUrl);
    }
    saveJson(TOP_KEY, topState);
    photoInput.value = "";
    renderPhotos();
    renderHeroBg();
    flash("ç™»éŒ²ã—ãŸ");
  });

  document.getElementById("clearPhotosBtn").addEventListener("click", ()=>{
    if(!confirm("ãƒˆãƒƒãƒ—å†™çœŸã‚’å…¨éƒ¨æ¶ˆã™ï¼Ÿ")) return;
    topState.photos = [];
    saveJson(TOP_KEY, topState);
    renderPhotos();
    renderHeroBg();
    flash("å…¨å‰Šé™¤ã—ãŸ");
  });

  // =========================
  // Trip persistence (local + share)
  // =========================
  let sbClient = null;
  let shareRealtime = null;

  async function sha256(text){
    const enc = new TextEncoder().encode(text);
    const digest = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  function logShare(msg){
    const box = document.getElementById("shareLog");
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `<div class="meta"><div class="t">ğŸ§· ãƒ­ã‚°</div><div class="s">${escapeHtml(msg)}</div></div>`;
    box.prepend(el);
  }

  async function canUseSupabase(){
    return !!(window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY);
  }

  async function initSupabase(){
    if(!(await canUseSupabase())) return null;
    if(sbClient) return sbClient;
    sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    return sbClient;
  }

  async function pullFromCloud(){
    if(!sbClient || !state.share.enabled) return false;
    const id = state.share.code;
    const pass_hash = state.share.passHash;

    const { data, error } = await sbClient
      .from(SHARE_TABLE)
      .select("data,updated_at")
      .eq("id", id)
      .eq("pass_hash", pass_hash)
      .maybeSingle();

    if(error){
      logShare("ã‚¯ãƒ©ã‚¦ãƒ‰å–å¾—ã‚¨ãƒ©ãƒ¼ï¼š" + error.message);
      return false;
    }
    if(!data){
      logShare("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã¾ã ãƒ‡ãƒ¼ã‚¿ç„¡ã—ï¼ˆåˆå›ä½œæˆã«ãªã‚Šã¾ã™ï¼‰");
      return false;
    }

    state = { ...structuredClone(defaultTripState), ...data.data };
    saveJson(TRIP_LOCAL_KEY, state);
    bootTripRender();
    logShare("ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰åŒæœŸã—ã¾ã—ãŸ");
    return true;
  }

  async function pushToCloud(reason="æ›´æ–°"){
    if(!sbClient || !state.share.enabled) return false;
    const id = state.share.code;
    const pass_hash = state.share.passHash;

    const payload = {
      id,
      pass_hash,
      data: state,
      updated_at: new Date().toISOString()
    };

    const { error } = await sbClient
      .from(SHARE_TABLE)
      .upsert(payload, { onConflict: "id" });

    if(error){
      logShare("ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š" + error.message);
      return false;
    }
    logShare("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸï¼ˆ" + reason + "ï¼‰");
    return true;
  }

  async function enableRealtime(){
    if(!sbClient || !state.share.enabled) return;

    if(shareRealtime) {
      try { await sbClient.removeChannel(shareRealtime); } catch(_){}
      shareRealtime = null;
    }

    shareRealtime = sbClient.channel("trip_sync_" + state.share.code)
      .on("postgres_changes",
        { event: "*", schema: "public", table: SHARE_TABLE, filter: "id=eq." + state.share.code },
        async () => {
          await pullFromCloud();
          flash("å…±æœ‰ï¼šæ›´æ–°ã‚’åæ˜ ");
        }
      ).subscribe((status)=>{
        logShare("ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼š" + status);
      });
  }

  async function ensureSync(reason="æ›´æ–°"){
    saveJson(TRIP_LOCAL_KEY, state);
    if(state.share.enabled){
      setSyncLabel("ä¿å­˜ï¼šå…±æœ‰ï¼ˆåŒæœŸä¸­ï¼‰");
      await pushToCloud(reason);
      setSyncLabel("ä¿å­˜ï¼šå…±æœ‰");
    }else{
      setSyncLabel("ä¿å­˜ï¼šãƒ­ãƒ¼ã‚«ãƒ«");
    }
  }

  // =========================
  // Day plans
  // =========================
  const daySelect = document.getElementById("daySelect");
  const dayMemo = document.getElementById("dayMemo");
  const planHour = document.getElementById("planHour");
  const planMin = document.getElementById("planMin");
  const planAllDay = document.getElementById("planAllDay");
  const planTitle = document.getElementById("planTitle");
  const planMove = document.getElementById("planMove");
  const planMoveMemo = document.getElementById("planMoveMemo");
  const planDesc = document.getElementById("planDesc");
  const planList = document.getElementById("planList");
  const planIcon = document.getElementById("planIcon");

  function fillTimeSelects(){
    planHour.innerHTML = "";
    for(let h=0; h<24; h++){
      const opt = document.createElement("option");
      opt.value = String(h).padStart(2,"0");
      opt.textContent = String(h).padStart(2,"0");
      planHour.appendChild(opt);
    }
    planMin.innerHTML = "";
    ["00","10","20","30","40","50"].forEach(m=>{
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      planMin.appendChild(opt);
    });
    planHour.value = "09";
    planMin.value = "00";
    planAllDay.value = "time";
    if(planIcon) planIcon.value = "none";
  }

  function ensureDay(date){
    if(!state.days[date]) state.days[date] = { memo:"", plans:[] };
  }

  function moveLabel(v){
    return ({ none:"æœªè¨­å®š", walk:"å¾’æ­©", mrt:"MRT", bus:"ãƒã‚¹", grab:"Grab/ã‚¿ã‚¯ã‚·ãƒ¼", other:"ãã®ä»–" }[v] || "æœªè¨­å®š");
  }

  function renderDaySelect(){
    daySelect.innerHTML = "";
    DATES.forEach(d=>{
      const opt = document.createElement("option");
      opt.value = d;
      opt.textContent = d;
      daySelect.appendChild(opt);
      ensureDay(d);
    });
  }

  function toMinutes(hhmm){
    const [hh, mm] = hhmm.split(":").map(Number);
    return hh*60 + mm;
  }

  function renderPlans(){
    const d = daySelect.value;
    ensureDay(d);
    dayMemo.value = state.days[d].memo || "";

    const plans = (state.days[d].plans || []).slice().sort((a,b)=>{
      const aKey = a.allDay ? -1 : (a.time ? toMinutes(a.time) : 99999);
      const bKey = b.allDay ? -1 : (b.time ? toMinutes(b.time) : 99999);
      return aKey - bKey || (a.createdAt||0)-(b.createdAt||0);
    });

    planList.innerHTML = "";
    if(plans.length===0){
      planList.innerHTML = `<div class="muted" style="margin-top:10px">ã¾ã äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    plans.forEach((p)=>{
      const el = document.createElement("div");
      el.className="item";

      const left = document.createElement("div");
      left.className="meta";

      const icon = iconLabel(p.icon || "none");
      left.innerHTML = `
        <div class="t">${escapeHtml(p.allDay ? "çµ‚æ—¥" : (p.time||"æœªè¨­å®š"))}ï½œ${icon ? icon + " " : ""}${escapeHtml(p.title||"")}</div>
        <div class="tag">ç§»å‹•ï¼š${escapeHtml(moveLabel(p.move||"none"))}${p.moveMemo ? "ï½œ" + escapeHtml(p.moveMemo) : ""}</div>
        <div class="s">${escapeHtml(p.desc||"")}</div>
      `;

      const right = document.createElement("div");
      right.className="row"; right.style.gap="8px";

      const del = document.createElement("button");
      del.className="btn danger";
      del.textContent="å‰Šé™¤";
      del.addEventListener("click", async ()=>{
        const date = daySelect.value;
        const arr = state.days[date].plans || [];
        state.days[date].plans = arr.filter(x=>x.createdAt!==p.createdAt);
        await ensureSync("äºˆå®šå‰Šé™¤");
        renderPlans();
      });

      right.appendChild(del);
      el.appendChild(left);
      el.appendChild(right);
      planList.appendChild(el);
    });
  }

  document.getElementById("addPlanBtn").addEventListener("click", async ()=>{
    const date = daySelect.value;
    ensureDay(date);

    const isAllDay = (planAllDay.value === "all");
    const timeStr = isAllDay ? "" : `${planHour.value}:${planMin.value}`;

    state.days[date].plans.push({
      allDay: isAllDay,
      time: timeStr,
      title: planTitle.value.trim(),
      icon: (planIcon?.value || "none"),
      move: planMove.value,
      moveMemo: planMoveMemo.value.trim(),
      desc: planDesc.value.trim(),
      createdAt: Date.now()
    });

    await ensureSync("äºˆå®šè¿½åŠ ");
    renderPlans();
  });

  document.getElementById("clearPlanInputs").addEventListener("click", ()=>{
    planAllDay.value="time";
    planHour.value="09";
    planMin.value="00";
    planTitle.value="";
    if(planIcon) planIcon.value="none";
    planMove.value="none";
    planMoveMemo.value="";
    planDesc.value="";
    flash("å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢");
  });

  daySelect.addEventListener("change", renderPlans);
  dayMemo.addEventListener("input", ()=>{
    const date = daySelect.value;
    ensureDay(date);
    state.days[date].memo = dayMemo.value;
    saveJson(TRIP_LOCAL_KEY, state);
    setSyncLabel(state.share.enabled ? "ä¿å­˜ï¼šå…±æœ‰ï¼ˆç·¨é›†ä¸­ï¼‰" : "ä¿å­˜ï¼šãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆç·¨é›†ä¸­ï¼‰");
    clearTimeout(window.__memoTimer);
    window.__memoTimer = setTimeout(async ()=>{ await ensureSync("æ—¥ä»˜ãƒ¡ãƒ¢æ›´æ–°"); }, 700);
  });

  // =========================
  // MRT image viewer (pan/zoom) + fit
  // =========================
  const mrtViewer = document.getElementById("mrtViewer");
  const mrtImg = document.getElementById("mrtImg");
  const mrtZoomIn = document.getElementById("mrtZoomIn");
  const mrtZoomOut = document.getElementById("mrtZoomOut");
  const mrtZoomReset = document.getElementById("mrtZoomReset");

  let mrtZ = 1, mrtX = 0, mrtY = 0;
  let mrtDragging = false, mrtLast = null;

  function applyMrtTransform(){
    if(!mrtImg) return;
    mrtImg.style.transform = `translate(${mrtX}px,${mrtY}px) scale(${mrtZ})`;
  }

  function mrtFit(){
    if(!mrtViewer || !mrtImg) return;
    const vw = mrtViewer.clientWidth;
    const vh = mrtViewer.clientHeight;

    const iw = mrtImg.naturalWidth || 1;
    const ih = mrtImg.naturalHeight || 1;

    const scale = Math.min(vw / iw, vh / ih);
    mrtZ = Math.min(6, Math.max(0.1, scale));

    mrtX = (vw - iw * mrtZ) / 2;
    mrtY = (vh - ih * mrtZ) / 2;
    applyMrtTransform();
  }

  function mrtReset(){
    mrtFit();
  }

  function mrtZoom(delta, center=null){
    const newZ = Math.min(6, Math.max(0.3, mrtZ * delta));
    if(newZ === mrtZ) return;

    if(center && mrtViewer){
      const rect = mrtViewer.getBoundingClientRect();
      const cx = center.x - rect.left;
      const cy = center.y - rect.top;

      const sx = (cx - mrtX) / mrtZ;
      const sy = (cy - mrtY) / mrtZ;
      mrtX = cx - sx * newZ;
      mrtY = cy - sy * newZ;
    }

    mrtZ = newZ;
    applyMrtTransform();
  }

  if(mrtZoomIn) mrtZoomIn.addEventListener("click", ()=>mrtZoom(1.2));
  if(mrtZoomOut) mrtZoomOut.addEventListener("click", ()=>mrtZoom(1/1.2));
  if(mrtZoomReset) mrtZoomReset.addEventListener("click", mrtReset);

  mrtImg?.addEventListener("load", ()=>{ mrtFit(); });

  if(mrtViewer){
    mrtViewer.addEventListener("wheel", (e)=>{
      e.preventDefault();
      const delta = e.deltaY < 0 ? 1.15 : 1/1.15;
      mrtZoom(delta, {x:e.clientX, y:e.clientY});
    }, {passive:false});

    mrtViewer.addEventListener("pointerdown", (e)=>{
      mrtDragging = true;
      mrtLast = {x:e.clientX, y:e.clientY};
      mrtViewer.setPointerCapture(e.pointerId);
    });
    mrtViewer.addEventListener("pointermove", (e)=>{
      if(!mrtDragging) return;
      const dx = e.clientX - mrtLast.x;
      const dy = e.clientY - mrtLast.y;
      mrtLast = {x:e.clientX, y:e.clientY};
      mrtX += dx; mrtY += dy;
      applyMrtTransform();
    });
    mrtViewer.addEventListener("pointerup", ()=>{
      mrtDragging = false; mrtLast = null;
    });
    mrtViewer.addEventListener("pointercancel", ()=>{
      mrtDragging = false; mrtLast = null;
    });
  }

  async function renderMrtUi(){
    const mrtFreeMemo = document.getElementById("mrtFreeMemo");
    if(mrtFreeMemo){
      mrtFreeMemo.value = (state.mrt && state.mrt.freeMemo) ? state.mrt.freeMemo : "";
    }
    // ã‚¿ãƒ–ã‚’é–‹ã„ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚‚fitï¼ˆiPhoneã§ã‚µã‚¤ã‚ºç¢ºå®šãŒé…ã„æ™‚ã«åŠ¹ãï¼‰
    setTimeout(mrtFit, 0);
  }

  document.getElementById("saveMrtFreeMemoBtn")?.addEventListener("click", async ()=>{
    const mrtFreeMemo = document.getElementById("mrtFreeMemo");
    state.mrt = state.mrt || {};
    state.mrt.freeMemo = (mrtFreeMemo?.value || "");
    await ensureSync("MRTãƒ¡ãƒ¢ä¿å­˜");
    flash("ä¿å­˜ã—ãŸ");
  });
  document.getElementById("clearMrtFreeMemoBtn")?.addEventListener("click", async ()=>{
    if(!confirm("MRTãƒ¡ãƒ¢ã‚’æ¶ˆã™ï¼Ÿ")) return;
    const mrtFreeMemo = document.getElementById("mrtFreeMemo");
    state.mrt = state.mrt || {};
    state.mrt.freeMemo = "";
    if(mrtFreeMemo) mrtFreeMemo.value="";
    await ensureSync("MRTãƒ¡ãƒ¢å‰Šé™¤");
    flash("æ¶ˆã—ãŸ");
  });

  // =========================
  // Google Maps: load once + init + language switch
  // =========================
  let gmap = null;
  let gmarkers = [];
  let geocoder = null;

  function mapCenter(){
    return { lat: 1.2897, lng: 103.8501 };
  }

  function pinColor(cat){
    return ({
      meal: "#ef4444",
      spot: "#4f46e5",
      shopping: "#06b6d4",
      hotel: "#f59e0b",
      move: "#10b981",
      note: "#64748b"
    }[cat] || "#4f46e5");
  }

  function clearMarkers(){
    gmarkers.forEach(m=>m.setMap(null));
    gmarkers = [];
  }

  function renderPinsOnGmap(){
    if(!gmap) return;
    clearMarkers();

    (state.pins || []).forEach(p=>{
      if(typeof p.lat !== "number" || typeof p.lng !== "number") return;

      const m = new google.maps.Marker({
        position: {lat:p.lat, lng:p.lng},
        map: gmap,
        title: p.name || "",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 8,
          fillColor: pinColor(p.cat),
          fillOpacity: 1,
          strokeColor: "#ffffff",
          strokeWeight: 2
        }
      });

      const info = new google.maps.InfoWindow({
        content: `<div style="font-weight:800">ğŸš© ${escapeHtml(p.name || "")}</div>
                  <div style="margin-top:6px;font-size:12px;color:#64748b">ã‚«ãƒ†ã‚´ãƒªï¼š${escapeHtml(p.cat||"spot")}</div>`
      });
      m.addListener("click", ()=>info.open({anchor:m, map:gmap}));
      gmarkers.push(m);
    });
  }

  function renderPinList(){
    const pinList = document.getElementById("pinList");
    pinList.innerHTML = "";

    if(!state.pins || state.pins.length===0){
      pinList.innerHTML = `<div class="muted" style="margin-top:10px">åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ——ã‚’è¿½åŠ </div>`;
      return;
    }

    state.pins.forEach((p, idx)=>{
      const el = document.createElement("div");
      el.className="item";

      const left = document.createElement("div");
      left.className="meta";
      left.innerHTML = `
        <div class="t">ğŸš© ${escapeHtml(p.name)}</div>
        <div class="tag">ã‚«ãƒ†ã‚´ãƒªï¼š${escapeHtml(p.cat||"spot")}</div>
        <div class="s">${(p.lat && p.lng) ? `${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}` : ""}</div>
      `;

      const right = document.createElement("div");
      right.className="row"; right.style.gap="8px";

      const go = document.createElement("button");
      go.className="btn secondary";
      go.textContent="åœ°å›³ã¸";
      go.addEventListener("click", ()=>{
        if(!gmap) return;
        gmap.panTo({lat:p.lat, lng:p.lng});
        gmap.setZoom(15);
      });

      const del = document.createElement("button");
      del.className="btn danger";
      del.textContent="å‰Šé™¤";
      del.addEventListener("click", async ()=>{
        state.pins.splice(idx,1);
        await ensureSync("æ——å‰Šé™¤");
        renderPinsOnGmap();
        renderPinList();
      });

      right.appendChild(go);
      right.appendChild(del);

      el.appendChild(left);
      el.appendChild(right);
      pinList.appendChild(el);
    });
  }

  async function addPin(lat, lng, name){
    const nm = (name || "").trim() || "ãƒ”ãƒ³";
    const cat = (document.getElementById("pinCat")?.value || "spot");
    state.pins.unshift({ name: nm, lat, lng, cat, createdAt: Date.now() });
    await ensureSync("æ——è¿½åŠ ");
    renderPinsOnGmap();
    renderPinList();
  }

  function ensureGoogleMapsLoaded(lang){
    return new Promise((resolve, reject)=>{
      if(window.google && window.google.maps){
        return resolve(true);
      }
      if(!GMAPS_API_KEY){
        return reject(new Error("GMAPS_API_KEYãŒç©º"));
      }
      const cbName = "__initGMap_" + Math.random().toString(16).slice(2);
      window[cbName] = ()=>{ resolve(true); delete window[cbName]; };

      const s = document.createElement("script");
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_API_KEY)}&libraries=places&language=${encodeURIComponent(lang)}&callback=${cbName}`;
      s.async = true;
      s.defer = true;
      s.onerror = ()=>reject(new Error("Google Mapsèª­ã¿è¾¼ã¿å¤±æ•—"));
      document.head.appendChild(s);
    });
  }

  async function initGmapOnce(){
    if(gmap) return true;

    const lang = document.getElementById("mapLang")?.value || "ja";
    await ensureGoogleMapsLoaded(lang);

    geocoder = new google.maps.Geocoder();

    gmap = new google.maps.Map(document.getElementById("gmap"), {
      center: mapCenter(),
      zoom: 12,
      gestureHandling: "greedy",
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false
    });

    // åœ°å›³ã‚¿ãƒƒãƒ—ã§æ——
    gmap.addListener("click", async (e)=>{
      const name = prompt("æ——ã®åå‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼ˆç©ºãªã‚‰ä½æ‰€ã£ã½ã„ã®ã«ã™ã‚‹ï¼‰") || "";
      const lat = e.latLng.lat();
      const lng = e.latLng.lng();

      let finalName = name.trim();
      if(!finalName && geocoder){
        try{
          const res = await geocoder.geocode({ location:{lat, lng} });
          const r0 = res.results && res.results[0];
          finalName = (r0 && r0.formatted_address) ? r0.formatted_address : "ãƒ”ãƒ³";
        }catch(_){
          finalName = "ãƒ”ãƒ³";
        }
      }
      await addPin(lat, lng, finalName);
    });

    renderPinsOnGmap();
    renderPinList();
    return true;
  }

  async function renderMap(){
    try{
      await initGmapOnce();
    }catch(e){
      flash("åœ°å›³ï¼šAPIã‚­ãƒ¼æœªè¨­å®š/èª­è¾¼å¤±æ•—");
      console.warn(e);
      renderPinList();
    }
  }

  document.getElementById("hintTapBtn")?.addEventListener("click", ()=>{
    alert("åœ°å›³ã®å¥½ããªå ´æ‰€ã‚’ã‚¿ãƒƒãƒ— â†’ æ——ã®åå‰ã‚’å…¥åŠ› â†’ è¿½åŠ ã•ã‚Œã¾ã™ï¼ˆã‚«ãƒ†ã‚´ãƒªã¯é¸æŠä¸­ã®ã‚‚ã®ï¼‰");
  });

  document.getElementById("addPinByAddressBtn")?.addEventListener("click", async ()=>{
    const addr = (document.getElementById("pinAddress")?.value || "").trim();
    const nmIn = (document.getElementById("pinName2")?.value || "").trim();
    if(!addr) return flash("ä½æ‰€/æ–½è¨­åã‚’å…¥ã‚Œã¦ã­");

    await renderMap();

    if(!(window.google && google.maps && geocoder)){
      return flash("åœ°å›³ãŒã¾ã ä½¿ãˆãªã„ï¼ˆAPIã‚­ãƒ¼ï¼‰");
    }

    try{
      const res = await geocoder.geocode({ address: addr });
      const r0 = res.results && res.results[0];
      if(!r0) return flash("è¦‹ã¤ã‹ã‚‰ãªã„ã‹ã‚‚â€¦ï¼ˆåˆ¥ã®è¨€ã„æ–¹ã§ï¼‰");
      const loc = r0.geometry.location;
      const lat = loc.lat();
      const lng = loc.lng();
      const finalName = nmIn || r0.formatted_address || addr;
      await addPin(lat, lng, finalName);
      if(gmap){
        gmap.panTo({lat, lng});
        gmap.setZoom(15);
      }
      document.getElementById("pinAddress").value = "";
      document.getElementById("pinName2").value = "";
      flash("æ——ã‚’è¿½åŠ ã—ãŸ");
    }catch(e){
      console.warn(e);
      flash("ä½æ‰€æ¤œç´¢ã«å¤±æ•—â€¦");
    }
  });

  document.getElementById("reloadMapBtn")?.addEventListener("click", ()=>{
    if(confirm("åœ°å›³ã®è¨€èªã‚’åæ˜ ã™ã‚‹ãŸã‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚OKï¼Ÿ")){
      location.reload();
    }
  });

  // =========================
  // Shopping
  // =========================
  const shopItem = document.getElementById("shopItem");
  const shopPlace = document.getElementById("shopPlace");
  const shopMemo = document.getElementById("shopMemo");
  const shopList = document.getElementById("shopList");

  function renderShop(){
    shopList.innerHTML = "";
    if((state.shopping||[]).length===0){
      shopList.innerHTML = `<div class="muted" style="margin-top:10px">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }
    state.shopping.forEach((s, idx)=>{
      const el = document.createElement("div");
      el.className="item";

      const left = document.createElement("div");
      left.className="meta";
      left.innerHTML = `
        <div class="t">${s.done ? "âœ…" : "ğŸ›ï¸"} ${escapeHtml(s.item)}</div>
        <div class="s">${escapeHtml(s.place || "")}${s.memo ? "ï½œ" + escapeHtml(s.memo) : ""}</div>
      `;

      const right = document.createElement("div");
      right.className="row"; right.style.gap="8px";

      const toggle = document.createElement("button");
      toggle.className="btn secondary";
      toggle.textContent = s.done ? "æˆ»ã™" : "å®Œäº†";
      toggle.addEventListener("click", async ()=>{
        s.done = !s.done;
        await ensureSync("è²·ã„ç‰©æ›´æ–°");
        renderShop();
      });

      const del = document.createElement("button");
      del.className="btn danger";
      del.textContent="å‰Šé™¤";
      del.addEventListener("click", async ()=>{
        state.shopping.splice(idx,1);
        await ensureSync("è²·ã„ç‰©å‰Šé™¤");
        renderShop();
      });

      right.appendChild(toggle);
      right.appendChild(del);

      el.appendChild(left);
      el.appendChild(right);
      shopList.appendChild(el);
    });
  }

  document.getElementById("addShopBtn").addEventListener("click", async ()=>{
    const item = shopItem.value.trim();
    if(!item) return flash("ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥ã‚Œã¦ã­");
    state.shopping.unshift({
      item,
      place: shopPlace.value.trim(),
      memo: shopMemo.value.trim(),
      done:false
    });
    shopItem.value=""; shopPlace.value=""; shopMemo.value="";
    await ensureSync("è²·ã„ç‰©è¿½åŠ ");
    renderShop();
  });

  // =========================
  // Tickets
  // =========================
  const ticketList = document.getElementById("ticketList");
  function renderTickets(){
    ticketList.innerHTML = "";
    if((state.tickets||[]).length===0){
      ticketList.innerHTML = `<div class="muted" style="margin-top:10px">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }
    state.tickets.forEach((t, idx)=>{
      const el = document.createElement("div");
      el.className="item";

      const left = document.createElement("div");
      left.className="meta";
      left.innerHTML = `
        <div class="t">ğŸ« ${escapeHtml(t.title)}</div>
        <div class="s">${linkify(escapeHtml(t.body||""))}</div>
        <div class="tag">æ›´æ–°ï¼š${new Date(t.updatedAt).toLocaleString("ja-JP")}</div>
      `;

      const right = document.createElement("div");
      right.className="row"; right.style.gap="8px";

      const del = document.createElement("button");
      del.className="btn danger";
      del.textContent="å‰Šé™¤";
      del.addEventListener("click", async ()=>{
        state.tickets.splice(idx,1);
        await ensureSync("ãƒã‚±ãƒƒãƒˆå‰Šé™¤");
        renderTickets();
      });

      right.appendChild(del);

      el.appendChild(left);
      el.appendChild(right);
      ticketList.appendChild(el);
    });
  }

  document.getElementById("addTicketBtn").addEventListener("click", async ()=>{
    const title = document.getElementById("tTitle").value.trim();
    const body = document.getElementById("tBody").value.trim();
    if(!title) return flash("ã‚¿ã‚¤ãƒˆãƒ«å…¥ã‚Œã¦ã­");
    state.tickets.unshift({ title, body, updatedAt: Date.now() });
    document.getElementById("tTitle").value="";
    document.getElementById("tBody").value="";
    await ensureSync("ãƒã‚±ãƒƒãƒˆè¿½åŠ ");
    renderTickets();
  });

  // =========================
  // Album
  // =========================
  const albumInput = document.getElementById("albumInput");
  const albumList = document.getElementById("albumList");
  const slideModal = document.getElementById("slideModal");
  const slideImg = document.getElementById("slideImg");
  const slideInfo = document.getElementById("slideInfo");
  let slideIdx = 0;
  let slideTimer = null;

  function renderAlbum(){
    if(!albumList) return;
    state.albumPhotos = state.albumPhotos || [];
    const arr = state.albumPhotos;

    albumList.innerHTML = "";
    if(arr.length===0){
      albumList.innerHTML = `<div class="muted" style="margin-top:10px">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    arr.slice().reverse().forEach((src, iFromEnd)=>{
      const idx = arr.length - 1 - iFromEnd;
      const el = document.createElement("div");
      el.className="item";
      el.innerHTML = `
        <div style="width:90px;height:60px;border-radius:12px;overflow:hidden;border:1px solid var(--border)">
          <img src="${src}" style="width:100%;height:100%;object-fit:cover;display:block" />
        </div>
        <div class="row" style="gap:8px">
          <button class="btn secondary" data-open="${idx}">è¦‹ã‚‹</button>
          <button class="btn danger" data-del="${idx}">å‰Šé™¤</button>
        </div>
      `;
      albumList.appendChild(el);
    });

    albumList.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const idx = Number(btn.dataset.del);
        state.albumPhotos.splice(idx,1);
        await ensureSync("ã‚¢ãƒ«ãƒãƒ å‰Šé™¤");
        renderAlbum();
      });
    });

    albumList.querySelectorAll("[data-open]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        openSlide(Number(btn.dataset.open));
      });
    });
  }

  function showSlide(){
    const arr = state.albumPhotos || [];
    if(arr.length===0) return;
    slideImg.src = arr[slideIdx];
    slideInfo.textContent = `${slideIdx+1} / ${arr.length}`;
  }

  function openSlide(idx){
    const arr = state.albumPhotos || [];
    if(arr.length===0) return;
    slideIdx = Math.max(0, Math.min(idx, arr.length-1));
    slideModal.classList.remove("hidden");
    showSlide();
  }

  function stopAuto(){
    if(slideTimer) clearInterval(slideTimer);
    slideTimer = null;
  }

  function closeSlide(){
    slideModal.classList.add("hidden");
    stopAuto();
  }

  function nextSlide(){
    const arr = state.albumPhotos || [];
    if(arr.length===0) return;
    slideIdx = (slideIdx + 1) % arr.length;
    showSlide();
  }

  function prevSlide(){
    const arr = state.albumPhotos || [];
    if(arr.length===0) return;
    slideIdx = (slideIdx - 1 + arr.length) % arr.length;
    showSlide();
  }

  function startAuto(){
    stopAuto();
    slideTimer = setInterval(nextSlide, 2500);
  }

  document.getElementById("addAlbumBtn")?.addEventListener("click", async ()=>{
    const files = Array.from(albumInput?.files || []);
    if(files.length===0) return flash("å†™çœŸã‚’é¸ã‚“ã§ã­");

    state.albumPhotos = state.albumPhotos || [];
    for(const f of files.slice(0, 30)){
      const dataUrl = await fileToDataURL(f);
      state.albumPhotos.push(dataUrl);
    }
    albumInput.value="";
    await ensureSync("ã‚¢ãƒ«ãƒãƒ è¿½åŠ ");
    renderAlbum();
    flash("è¿½åŠ ã—ãŸ");
  });

  document.getElementById("clearAlbumBtn")?.addEventListener("click", async ()=>{
    if(!confirm("ã‚¢ãƒ«ãƒãƒ ã‚’å…¨éƒ¨æ¶ˆã™ï¼Ÿ")) return;
    state.albumPhotos = [];
    await ensureSync("ã‚¢ãƒ«ãƒãƒ å…¨å‰Šé™¤");
    renderAlbum();
  });

  document.getElementById("playSlideBtn")?.addEventListener("click", ()=>{
    openSlide(0);
    startAuto();
  });

  document.getElementById("closeSlideBtn")?.addEventListener("click", closeSlide);
  document.getElementById("nextSlideBtn")?.addEventListener("click", ()=>{ stopAuto(); nextSlide(); });
  document.getElementById("prevSlideBtn")?.addEventListener("click", ()=>{ stopAuto(); prevSlide(); });

  slideModal?.addEventListener("click", (e)=>{
    if(e.target === slideModal) closeSlide();
  });

  // =========================
  // Share UI
  // =========================
  document.getElementById("connectShareBtn").addEventListener("click", async ()=>{
    const code = document.getElementById("shareCode").value.trim();
    const pass = document.getElementById("sharePass").value;
    if(!code || !pass) return flash("å…±æœ‰ã‚³ãƒ¼ãƒ‰ã¨åˆè¨€è‘‰ã‚’å…¥ã‚Œã¦ã­");

    if(!(await canUseSupabase())){
      logShare("Supabaseæœªè¨­å®šï¼šã‚³ãƒ¼ãƒ‰å†…ã®URL/KEYã‚’è¨­å®šã—ã¦ã­");
      return flash("Supabaseæœªè¨­å®š");
    }

    await initSupabase();

    state.share.enabled = true;
    state.share.code = code;
    state.share.passHash = await sha256(pass);

    setSyncLabel("ä¿å­˜ï¼šå…±æœ‰ï¼ˆæ¥ç¶šä¸­ï¼‰");
    logShare("å…±æœ‰ã‚’æœ‰åŠ¹åŒ–ï¼š" + code);

    // å…ˆã«pullï¼ˆã‚ã‚Œã°å–ã‚Šè¾¼ã‚€ï¼‰
    await pullFromCloud();
    // ä»Šã®çŠ¶æ…‹ã‚’pushï¼ˆåˆå›ä½œæˆã«ã‚‚ãªã‚‹ï¼‰
    await pushToCloud("å…±æœ‰é–‹å§‹");
    await enableRealtime();
    await ensureSync("å…±æœ‰é–‹å§‹");
    flash("å…±æœ‰ã§ä½¿ã†");
  });

  document.getElementById("disconnectShareBtn").addEventListener("click", async ()=>{
    state.share.enabled = false;
    state.share.code = "";
    state.share.passHash = "";
    setSyncLabel("ä¿å­˜ï¼šãƒ­ãƒ¼ã‚«ãƒ«");
    logShare("å…±æœ‰ã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã¸ï¼‰");
    saveJson(TRIP_LOCAL_KEY, state);

    if(sbClient && shareRealtime){
      try{ await sbClient.removeChannel(shareRealtime); }catch(_){}
      shareRealtime = null;
    }
    flash("ãƒ­ãƒ¼ã‚«ãƒ«ã«æˆ»ã—ãŸ");
  });

  // =========================
  // Boot
  // =========================
  function bootTopRender(){
    renderPhotos();
    renderHeroBg();
    topState.ui = topState.ui || {};
    setPhotoPanel(topState.ui.photoPanelOpen !== false);
  }

  function bootTripRender(){
    fillTimeSelects();
    renderDaySelect();
    daySelect.value = DATES[0];
    renderPlans();
    renderShop();
    renderTickets();
    renderAlbum();
    document.getElementById("shareCode").value = state.share.code || "";
    setSyncLabel(state.share.enabled ? "ä¿å­˜ï¼šå…±æœ‰" : "ä¿å­˜ï¼šãƒ­ãƒ¼ã‚«ãƒ«");
  }

  // start
  showTop();
  bootTopRender();
  bootTripRender();
</script>

<!-- Service Worker -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(console.warn);
    });
  }
</script>

</body>
</html>
